{% extends "base.html" %}

{% block title %}Search Results for "{{ query }}"{% endblock %}

{% block content %}
    <h2>Search Results for "{{ query }}"</h2>

    {% if total_results is defined and total_results > 0 %}
        <p class="search-summary">{{ total_results }} products found.</p>
    {% endif %}

    <div class="search-results-container">
        <aside class="facet-sidebar">
            {% include '_facet_sidebar.html' %}
        </aside>

        <div class="search-results-grid">
            {% if error %}
                <p class="error">An error occurred: {{ error }}</p>
                <p>Please ensure your `config.py` is correct and you have imported product data into your catalog.</p>
            {% elif results %}
                <div class="product-grid">
                    {% for result in results %}
                        <div class="product-card">
                            <a href="{{ url_for('product_detail', product_id=result.id, attribution_token=attribution_token) }}">
                                <img src="{{ (result.product.images[0].uri if result.product.images) or 'https://prd.place/400?id=' ~ result.id }}" alt="{{ result.product.title or 'Untitled Product' }}">
                                <h3 class="product-title">{{ result.product.title or "Untitled Product" }}</h3>
                                <p class="product-id-debug">ID: {{ result.id }}</p>
                                {% if result.product.price_info and result.product.price_info.price is defined and result.product.price_info.price is not none %}
                                    <p class="price">${{ "%.2f"|format(result.product.price_info.price) }}</p>
                                {% else %}
                                    <p class="price price-unavailable">Price not available</p>
                                {% endif %}
                            </a>
                        </div>
                    {% endfor %}
                </div>
                {% include '_pagination.html' %}
            {% else %}
                <p>No products found for your query.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {% if not error %}
        <script>
            const searchResults = {{ results_json|tojson|safe }};
            const query = {{ query|tojson|safe }};
            const attributionToken = {{ search_event_attribution_token|tojson|safe }};
            VibeTracker.trackSearchView(query, searchResults, attributionToken);
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Facet collapse/expand logic
                const facetToggles = document.querySelectorAll('.facet-toggle');

                facetToggles.forEach(toggle => {
                    const content = document.getElementById(toggle.getAttribute('aria-controls'));

                    toggle.addEventListener('click', () => {
                        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                        toggle.setAttribute('aria-expanded', !isExpanded);
                        content.classList.toggle('is-collapsed');

                        if (content.classList.contains('is-collapsed')) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + 'px';
                        }
                    });
                });
            });
        </script>
    {% endif %}
{% endblock %}