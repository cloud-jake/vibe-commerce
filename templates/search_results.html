{% extends "base.html" %}
{% from '_macros.html' import render_product_card, render_facets, render_pagination %}

{% block title %}Search Results for "{{ query }}"{% endblock %}

{% block content %}
    <h2>Search Results for "{{ query }}"</h2>

    {% if total_results is defined and total_results > 0 %}
        <p class="search-summary">{{ total_results }} products found.</p>
    {% endif %}

    <div class="search-results-container">
        <aside class="facet-sidebar">
            {{ render_facets(facets, selected_facets, request.path, request.args, attribution_token, query=query) }}
        </aside>

        <div class="search-results-grid">
            {% if error %}
                <p class="error">An error occurred: {{ error }}</p>
                <p>Please ensure your `config.py` is correct and you have imported product data into your catalog.</p>
            {% elif results %}
                <div class="product-grid">
                    {% for result in results %}
                        {{ render_product_card(result, attribution_token) }}
                    {% endfor %}
                </div>
                {{ render_pagination(current_page, total_pages, total_results, page_size, results|length, request.path, request.args, attribution_token) }}
            {% else %}
                <p>No products found for your query.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {% if not error %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // This event tracks that a user performed a search.
                // It includes the query, any filters, the results shown, and the attribution token
                // from the previous page (e.g., autocomplete suggestion click).
                VibeTracker.trackSearchView(
                    {{ query|tojson|safe }},
                    {{ results_json|tojson|safe }},
                    {{ search_event_attribution_token|tojson|safe }},
                    {{ search_filter|tojson|safe }}
                );
            });
        </script>
    {% endif %}
{% endblock %}