{% extends "base.html" %}

{% block title %}AI Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-history" id="chat-history">
        {% if not chat_history %}
            <div class="chat-message bot-message">
                <div class="bot-icon-wrapper">
                    <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#4285F4">
                                <animate attributeName="stop-color" values="#4285F4; #9B72F9; #EA4335; #FBBC05; #34A853; #4285F4" dur="4s" repeatCount="indefinite"></animate>
                            </stop>
                            <stop offset="100%" stop-color="#9B72F9">
                                <animate attributeName="stop-color" values="#9B72F9; #EA4335; #FBBC05; #34A853; #4285F4; #9B72F9" dur="4s" repeatCount="indefinite"></animate>
                            </stop>
                            </linearGradient>
                        </defs>
                        <path fill="url(#geminiGradient)" d="M12 2L13.5 10.5L22 12L13.5 13.5L12 22L10.5 13.5L2 12L10.5 10.5L12 2Z"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="6s" repeatCount="indefinite"/></path>
                    </svg>
                </div>
                <div class="bot-message-content">
                    <p>Welcome to the Vibe Commerce AI assistant! How can I help you find the perfect product today?</p>
                </div>
            </div>
        {% endif %}
        {% for message in chat_history %}
            {% if message.is_user %}
                <div class="chat-message user-message">
                    <p>{{ message.text }}</p>
                </div>
            {% else %}
                <div class="chat-message bot-message">
                    <div class="bot-icon-wrapper">
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#4285F4">
                                    <animate attributeName="stop-color" values="#4285F4; #9B72F9; #EA4335; #FBBC05; #34A853; #4285F4" dur="4s" repeatCount="indefinite"></animate>
                                </stop>
                                <stop offset="100%" stop-color="#9B72F9">
                                    <animate attributeName="stop-color" values="#9B72F9; #EA4335; #FBBC05; #34A853; #4285F4; #9B72F9" dur="4s" repeatCount="indefinite"></animate>
                                </stop>
                                </linearGradient>
                            </defs>
                            <path fill="url(#geminiGradient)" d="M12 2L13.5 10.5L22 12L13.5 13.5L12 22L10.5 13.5L2 12L10.5 10.5L12 2Z"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="6s" repeatCount="indefinite"/></path>
                        </svg>
                    </div>
                    <div class="bot-message-content">
                        {% if message.text %}
                            <p>{{ message.text | safe }}</p>
                        {% endif %}

                        {% if message.products %}
                            <div class="product-carousel">
                                <div class="product-grid">
                                    {# The products are stored as dictionaries in the session, so we access keys with dot notation. #}
                                    {# The keys are camelCase (e.g., 'priceInfo') as they come from the .to_dict() conversion. #}
                                    {% for result in message.products %}
                                        {% set product = result.product %}
                                        <div class="product-card">
                                            <a href="{{ url_for('product_detail', product_id=result.id) }}" target="_blank" rel="noopener noreferrer">
                                                <img src="{{ (product.images[0].uri if product.images) or 'https://via.placeholder.com/200' }}" alt="{{ product.title or 'Untitled Product' }}">
                                                <h3 class="product-title">{{ product.title or "Untitled Product" }}</h3>
                                                {% if product.price_info and product.price_info.price is defined and product.price_info.price is not none %}
                                                    <p class="price">${{ "%.2f"|format(product.price_info.price) }}</p>
                                                {% else %}
                                                    <p class="price price-unavailable">Price not available</p>
                                                {% endif %}
                                            </a>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if message.refined_queries %}
                            <div class="refined-queries">
                                <p>You could also try:</p>
                                {% for refined_query in message.refined_queries %}
                                    <button type="button" class="refined-query-button" data-query="{{ refined_query }}">{{ refined_query }}</button>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if message.page_links %}
                            <div class="page-links">
                                {% for link in message.page_links %}
                                    {# These are direct links, not queries, so they use an <a> tag #}
                                    <a href="{{ link.url }}" class="page-link-button" target="_blank" rel="noopener noreferrer">{{ link.text }}</a>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if message.followup_question %}
                            <p class="followup-question">{{ message.followup_question }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="chat-input-area">
        <form action="{{ url_for('api_chat') }}" method="post" class="chat-form" id="chat-form">
            <textarea name="query" id="query-input" placeholder="Ask me anything about our products..." required autofocus autocomplete="off" rows="1"></textarea>
            <button type="submit" title="Send">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </form>
        <button type="button" id="mic-button" class="mic-button" title="Speak your query">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>
        <form action="{{ url_for('clear_chat') }}" method="post" class="clear-chat-form">
            <button type="submit">Clear Chat</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatForm = document.getElementById('chat-form');
    const queryInput = document.getElementById('query-input');
    const chatHistory = document.getElementById('chat-history');
    let conversationId = '{{ conversation_id }}'; // Get initial ID from Flask

    // --- Auto-resize textarea ---
    const adjustTextareaHeight = () => {
        queryInput.style.height = 'auto'; // Reset height to calculate scrollHeight correctly
        const maxHeight = 150; // Max height in pixels
        const newHeight = Math.min(queryInput.scrollHeight, maxHeight);
        queryInput.style.height = `${newHeight}px`;
        // Show scrollbar only when max height is reached
        queryInput.style.overflowY = (queryInput.scrollHeight > maxHeight) ? 'auto' : 'hidden';
    };

    queryInput.addEventListener('input', adjustTextareaHeight);

    // --- Handle Enter to submit, Shift+Enter for new line ---
    queryInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent new line
            chatForm.requestSubmit();
        }
    });

    const scrollToBottom = () => {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    };

    const renderBotMessage = (message) => {
        const iconHtml = `
            <div class="bot-icon-wrapper">
                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#4285F4">
                            <animate attributeName="stop-color" values="#4285F4; #9B72F9; #EA4335; #FBBC05; #34A853; #4285F4" dur="4s" repeatCount="indefinite"></animate>
                        </stop>
                        <stop offset="100%" stop-color="#9B72F9">
                            <animate attributeName="stop-color" values="#9B72F9; #EA4335; #FBBC05; #34A853; #4285F4; #9B72F9" dur="4s" repeatCount="indefinite"></animate>
                        </stop>
                        </linearGradient>
                    </defs>
                    <path fill="url(#geminiGradient)" d="M12 2L13.5 10.5L22 12L13.5 13.5L12 22L10.5 13.5L2 12L10.5 10.5L12 2Z"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="6s" repeatCount="indefinite"/></path>
                </svg>
            </div>
        `;

        let contentHtml = '<div class="bot-message-content">';
        if (message.text) {
            contentHtml += `<p>${message.text}</p>`;
        }
        if (message.products && message.products.length > 0) {
            contentHtml += '<div class="product-carousel"><div class="product-grid">';
            message.products.forEach(result => {
                const product = result.product;
                const imageUrl = (product.images && product.images.length > 0) ? product.images[0].uri : 'https://via.placeholder.com/200';
                const title = product.title || 'Untitled Product';
                const detailUrl = `/product/${result.id}`;
                
                let priceHtml;
                if (product.price_info && product.price_info.price !== null && typeof product.price_info.price !== 'undefined') {
                    priceHtml = `<p class="price">$${product.price_info.price.toFixed(2)}</p>`;
                } else {
                    priceHtml = `<p class="price price-unavailable">Price not available</p>`;
                }

                contentHtml += `
                    <div class="product-card">
                        <a href="${detailUrl}" target="_blank" rel="noopener noreferrer">
                            <img src="${imageUrl}" alt="${title}">
                            <h3 class="product-title">${title}</h3>
                            ${priceHtml}
                        </a>
                    </div>
                `;
            });
            contentHtml += '</div></div>';
        }
        if (message.refined_queries && message.refined_queries.length > 0) {
            contentHtml += '<div class="refined-queries"><p>You could also try:</p>';
            message.refined_queries.forEach(q => {
                contentHtml += `<button type="button" class="refined-query-button" data-query="${q}">${q}</button>`;
            });
            contentHtml += '</div>';
        }
        if (message.page_links && message.page_links.length > 0) {
            contentHtml += '<div class="page-links">';
            message.page_links.forEach(link => {
                contentHtml += `<a href="${link.url}" class="page-link-button" target="_blank" rel="noopener noreferrer">${link.text}</a>`;
            });
            contentHtml += '</div>';
        }
        if (message.followup_question) {
            contentHtml += `<p class="followup-question">${message.followup_question}</p>`;
        }
        contentHtml += '</div>';
        return iconHtml + contentHtml;
    };

    const addMessageToUI = (content, isUser) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
        messageDiv.innerHTML = content;
        chatHistory.appendChild(messageDiv);
        if (isUser) {
            scrollToBottom();
        } else {
            // For bot messages, scroll to the top of the new message so the user sees it.
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    const showTypingIndicator = () => {
        const indicator = document.createElement('div');
        indicator.className = 'chat-message bot-message typing-indicator';
        indicator.innerHTML = '<p><span>.</span><span>.</span><span>.</span></p>';
        indicator.id = 'typing-indicator';
        chatHistory.appendChild(indicator);
        scrollToBottom();
    };

    const removeTypingIndicator = () => {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    };

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = queryInput.value.trim();
        if (!query) return;

        addMessageToUI(`<p>${query}</p>`, true);
        queryInput.value = '';
        adjustTextareaHeight(); // Reset textarea height after submit
        showTypingIndicator();

        try {
            const response = await fetch(chatForm.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query, conversation_id: conversationId })
            });

            removeTypingIndicator();
            const data = await response.json();

            if (!response.ok) {
                addMessageToUI(`<p>${data.bot_response.text || 'Sorry, an error occurred.'}</p>`, false);
                return;
            }

            conversationId = data.conversation_id;
            addMessageToUI(renderBotMessage(data.bot_response), false);
        } catch (error) {
            removeTypingIndicator();
            console.error('Chat API error:', error);
            addMessageToUI('<p>Sorry, I could not connect to the server.</p>', false);
        }
    });

    chatHistory.addEventListener('click', (e) => {
        if (e.target && e.target.classList.contains('refined-query-button')) {
            queryInput.value = e.target.dataset.query;
            adjustTextareaHeight(); // Adjust height for the new content
            chatForm.requestSubmit();
        }
    });

    // --- Speech Recognition Logic ---
    const micButton = document.getElementById('mic-button');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition && micButton) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false; // Stop listening after a pause
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        micButton.addEventListener('click', () => {
            recognition.start();
            micButton.classList.add('is-listening');
            queryInput.placeholder = 'Listening...';
        });

        recognition.onresult = (event) => {
            const speechResult = event.results[0][0].transcript;
            queryInput.value = speechResult;
            adjustTextareaHeight(); // Adjust height for the new content
            // Automatically submit the form after successful recognition
            chatForm.requestSubmit();
        };

        recognition.onspeechend = () => {
            recognition.stop();
            micButton.classList.remove('is-listening');
            queryInput.placeholder = 'Ask me anything about our products...';
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            micButton.classList.remove('is-listening');
            queryInput.placeholder = 'Sorry, I could not hear you. Please try again.';
        };
    } else if (micButton) {
        // Hide the button if the browser doesn't support the API
        micButton.style.display = 'none';
        console.warn('Speech Recognition API not supported in this browser.');
    }

    scrollToBottom();
});
</script>
{% endblock %}