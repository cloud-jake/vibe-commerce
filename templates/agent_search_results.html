{% extends "base.html" %}
{% from '_macros.html' import render_product_card, render_facets, render_pagination %}

{% block title %}Conversational Search - {{ site_name }}{% endblock %}

{% block content %}
<div class="search-results-container">
    <aside class="facet-sidebar">
        {# Render facets only if we have product results to filter #}
        {% if results %}
            {{ render_facets(facets, selected_facets, request.path, request.args, attribution_token, query=query) }}
        {% endif %}
    </aside>

    <div class="search-results-grid">
        {# This is the main conversational part, which always shows #}
        {% if response %}
        <div class="agent-response-container mb-4">
            <h2 class="h5 mb-0">
                <button class="agent-section-toggle{% if collapse_agent_response %} collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#agent-response-body" aria-expanded="{{ 'false' if collapse_agent_response else 'true' }}" aria-controls="agent-response-body">
                    <div class="d-flex align-items-center">
                        <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="20" height="20" style="flex-shrink: 0;"><path d="M16 8.016A8.522 8.522 0 008.016 16h-.032A8.521 8.521 0 000 8.016v-.032A8.521 8.521 0 007.984 0h.032A8.522 8.522 0 0016 7.984v.032z" fill="url(#prefix__paint0_radial_980_20147)"/><defs><radialGradient id="prefix__paint0_radial_980_20147" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="matrix(16.1326 5.4553 -43.70045 129.2322 1.588 6.503)"><stop offset=".067" stop-color="#9168C0"/><stop offset=".343" stop-color="#5684D1"/><stop offset=".672" stop-color="#1BA1E3"/></radialGradient></defs></svg>
                        <span class="ms-2">AI Assistant Response</span>
                    </div>
                    <svg class="facet-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </h2>
            <div class="collapse{% if not collapse_agent_response %} show{% endif %}" id="agent-response-body">
                <div class="chat-message bot-message">
                    <div class="bot-message-content" style="background-color: var(--surface-color);">
                        {% if response.conversational_text_response %}
                            <p>{{ response.conversational_text_response | safe }}</p>
                        {% endif %}

                        {% if page_links %}
                        <div class="page-links">
                            {% for link in page_links %}
                                <a href="{{ link.url }}" class="page-link-button" target="_blank" rel="noopener noreferrer">{{ link.text }}</a>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {# Only show related searches if there's more than one refined query #}
                        {% if response.refined_search|length > 1 %}
                        <div class="refined-queries">
                            <p>Related Searches:</p>
                            {# Slice the list to show all but the first one, which is used for the main results #}
                            {% for rs in response.refined_search[1:] %}
                                <a href="{{ url_for('agent_search', query=rs.query, conversation_id=conversation_id) }}" class="refined-query-button" style="text-decoration: none;">
                                    {{ rs.query }}
                                </a>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {# For a follow-up question, show the question and a dedicated input form #}
                        {% set has_followup = response.followup_question.followup_question %}
                        {% set has_content = response.conversational_text_response or page_links or response.refined_search|length > 1 %}

                        {% if has_followup %}
                            <p class="followup-question">{{ response.followup_question.followup_question }}</p>
                        {% endif %}

                        {# Show input for a follow-up question, or if the agent response is collapsed (i.e., for a simple search). #}
                        {% if has_followup or collapse_agent_response %}
                            <div class="chat-input-area" style="padding: 10px 0 0 0; {% if has_content or has_followup %}border-top: 1px solid #e0e0e0;{% endif %} background: transparent;">
                                <form action="{{ url_for('agent_search') }}" method="get" class="chat-form" id="followup-form">
                                    <input type="hidden" name="conversation_id" value="{{ conversation_id }}">
                                    <textarea name="query" placeholder="{{ 'Answer here...' if has_followup else 'Continue the conversation...' }}" required rows="1" style="resize: none; overflow-y: hidden;"></textarea>
                                    <button type="submit" title="Send"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# This is the product grid part #}
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% elif results %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3">Products for "{{ response.refined_search[0].query if response.refined_search else query }}"</h1>
                    <p class="text-muted">
                        Showing {{ results|length }} of {{ "{:,}".format(total_results) }} results.
                    </p>
                </div>
            </div>
            <div class="product-grid">
                {% for result in results %}
                    {{ render_product_card(result, attribution_token) }}
                {% endfor %}
            </div>
            <!-- Pagination -->
            {{ render_pagination(current_page, total_pages, total_results, page_size, results|length, request.path, request.args, attribution_token) }}
        {% elif not page_links and response %}
            {# Only show "no products" if it wasn't a support query that generated page_links and we had a conversational response #}
            <div class="text-center py-5">
                <h4>No products found for your query.</h4>
                <p>Try a different search to find what you're looking for.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
    .agent-response-container {
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    .agent-section-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        background-color: #f8f9fa;
        border: none;
        text-align: left;
        border-radius: 8px;
    }
    .agent-section-toggle:not(.collapsed) {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom: 1px solid var(--border-color);
    }
    .agent-section-toggle .facet-toggle-icon {
        transition: transform 0.2s ease-in-out;
        transform: rotate(180deg);
        width: 16px;
        height: 16px;
    }
    .agent-section-toggle.collapsed .facet-toggle-icon {
        transform: rotate(0deg);
    }
    #agent-response-body {
        padding: 1rem;
    }
    #agent-response-body .chat-message {
        margin-bottom: 0 !important;
    }
    /* Override the default 75% max-width for chat messages for this specific container */
    #agent-response-body .bot-message {
        max-width: 100%;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const mainSearchForm = document.getElementById('main-search-form');
    const mainQueryInput = mainSearchForm.querySelector('input[name="query"]');
    const conversationId = '{{ conversation_id }}';
    const followupForm = document.getElementById('followup-form');

    if (mainSearchForm && conversationId) {
        // Change the form's action to point to the agent search endpoint
        mainSearchForm.action = '{{ url_for("agent_search") }}';

        // Add the conversation_id as a hidden input
        let hiddenInput = mainSearchForm.querySelector('input[name="conversation_id"]');
        if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'conversation_id';
            mainSearchForm.appendChild(hiddenInput);
        }
        hiddenInput.value = conversationId;

        // Update the placeholder text to reflect the conversational context
        {% if response and response.followup_question.followup_question %}
            mainQueryInput.placeholder = 'Answer here...';
        {% else %}
            mainQueryInput.placeholder = 'Continue the conversation...';
        {% endif %}
    }

    // Add auto-resize and submit-on-enter logic for the followup textarea
    if (followupForm) {
        const followupTextarea = followupForm.querySelector('textarea');

        const adjustTextareaHeight = () => {
            followupTextarea.style.height = 'auto';
            const maxHeight = 150;
            const newHeight = Math.min(followupTextarea.scrollHeight, maxHeight);
            followupTextarea.style.height = `${newHeight}px`;
            followupTextarea.style.overflowY = (followupTextarea.scrollHeight > maxHeight) ? 'auto' : 'hidden';
        };

        followupTextarea.addEventListener('input', adjustTextareaHeight);

        followupTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                followupForm.requestSubmit();
            }
        });
        adjustTextareaHeight(); // Initial adjustment
    }
});
</script>
{% endblock %}