{#
    This template renders the facet sidebar for search results.
    It displays currently applied filters and available facet options.
#}

<div class="applied-filters">
    <h4>Applied Filters</h4>
    {% if selected_facets %}
        <ul>
        {% for key, values in selected_facets.items() %}
            {% for value in values %}
                <li class="applied-filter-tag">
                    {% set display_value = value %}
                    {% if (key == 'price' or key == 'rating') and '-' in value %}
                        {% set parts = value.split('-') %}
                        {% set min_val, max_val = parts[0], parts[1] %}
                        {% if key == 'price' %}
                            {% if min_val and max_val %}{% set display_value = '$' ~ min_val ~ ' - $' ~ max_val %}{% elif min_val %}{% set display_value = '$' ~ min_val ~ '+' %}{% else %}{% set display_value = 'Up to $' ~ max_val %}{% endif %}
                        {% else %}
                            {% if min_val and max_val %}{% set display_value = min_val ~ ' - ' ~ max_val %}{% elif min_val %}{% set display_value = min_val ~ '+' %}{% else %}{% set display_value = 'Up to ' ~ max_val %}{% endif %}
                        {% endif %}
                    {% endif %}
                    {{ display_value }}
                    {# Logic to create a URL to remove this specific facet value #}
                    {% set new_args = request.args.to_dict(flat=False) %}
                    {% set _ = new_args[key].remove(value) %}
                    {# If the key has no more values, remove the key itself #}
                    {% if not new_args[key] %}{% set _ = new_args.pop(key) %}{% endif %}
                    {% if attribution_token %}{% set _ = new_args.update({'attribution_token': attribution_token}) %}{% endif %}
                    <a href="{{ url_for('search', **new_args) }}" class="remove-facet-link" title="Remove filter">&times;</a>
                </li>
            {% endfor %}
        {% endfor %}
        </ul>
        <a href="{{ url_for('search', query=query, expand=request.args.get('expand'), attribution_token=attribution_token) }}" class="clear-all-filters">Clear All</a>
    {% else %}
        <p>None</p>
    {% endif %}
</div>

<hr>

<div class="available-facets">
    <h4>Refine By</h4>
    {# Loop through facets, but only those that have values to display. #}
    {% for facet in facets if facet.values %}
        <div class="facet-group">
            {# Generate a user-friendly display name if one isn't provided by the API #}
            {% set display_name = facet.display_name %}
            {% if not display_name and facet.key.startswith('attributes.') %}
                {% set display_name = facet.key[11:]|replace('_', ' ')|title %}
            {% elif not display_name %}
                {% set display_name = facet.key|replace('_', ' ')|title %}
            {% endif %}
            <h5>{{ display_name }}</h5>
            <ul>
                {% for val in facet.values %}
                    {% set facet_display, facet_value_for_url = '', '' %}
                    {% if val.value %}
                        {# This is a standard text facet #}
                        {% set facet_display, facet_value_for_url = val.value, val.value %}
                    {% elif val.interval %}
                        {# This is a numerical interval facet. #}
                        {% set min_val = val.interval.minimum if val.interval.minimum is defined else '' %}
                        {% set max_val = val.interval.maximum if val.interval.maximum is defined else '' %}
                        {% set facet_value_for_url = '%s-%s'|format(min_val, max_val) %}

                        {# Create a user-friendly display string #}
                        {% if facet.key == 'price' %}
                            {% if min_val and max_val %}{% set facet_display = "$%.2f - $%.2f"|format(min_val, max_val) %}{% elif min_val %}{% set facet_display = "$%.2f+"|format(min_val) %}{% else %}{% set facet_display = "Up to $%.2f"|format(max_val) %}{% endif %}
                        {% elif facet.key == 'rating' %}
                            {% if min_val and max_val %}{% set facet_display = "%.1f - %.1f stars"|format(min_val, max_val) %}{% elif min_val %}{% set facet_display = "%.1f+ stars"|format(min_val) %}{% else %}{% set facet_display = "Up to %.1f stars"|format(max_val) %}{% endif %}
                        {% else %} {# Default display for other numericals #}
                            {% if min_val and max_val %}{% set facet_display = "%s - %s"|format(min_val, max_val) %}{% elif min_val %}{% set facet_display = "%s+"|format(min_val) %}{% else %}{% set facet_display = "Up to %s"|format(max_val) %}{% endif %}
                        {% endif %}
                    {% endif %}
                    {% if facet_display %}
                        {% set add_args = request.args.to_dict(flat=False) %}
                        {# Add the new facet value. This handles keys that might already exist. #}
                        {% set existing_values = add_args.get(facet.key, []) %}
                        {% set _ = add_args.update({facet.key: existing_values + [facet_value_for_url]}) %}
                        {% if attribution_token %}{% set _ = add_args.update({'attribution_token': attribution_token}) %}{% endif %}
                        <li class="facet-item"><a href="{{ url_for('search', **add_args) }}">{{ facet_display }} ({{ val.count }})</a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% else %}
        {# This block renders if the 'facets' list is empty or no facets have values. #}
        <p>No filters available for this search.</p>
    {% endfor %}
</div>