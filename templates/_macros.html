{#
    This file contains reusable macros for rendering common components
    like product cards, facet sidebars, and pagination.
#}

{% macro render_product_card(result, attribution_token) %}
<div class="product-card">
    {# The result object is a SearchResult, which has .id and .product #}
    <a href="{{ url_for('product_detail', product_id=result.id, attribution_token=attribution_token) }}">
        <img src="{{ (result.product.images[0].uri if result.product.images) or 'https://prd.place/400?id=' ~ result.id }}" alt="{{ result.product.title or 'Untitled Product' }}">
        <h3 class="product-title">{{ result.product.title or "Untitled Product" }}</h3>
        {% if result.product.price_info and result.product.price_info.price is defined and result.product.price_info.price is not none %}
            <p class="price">${{ "%.2f"|format(result.product.price_info.price) }}</p>
        {% else %}
            <p class="price price-unavailable">Price not available</p>
        {% endif %}
    </a>
</div>
{% endmacro %}


{% macro render_facets(facets, selected_facets, request_path, request_args, attribution_token, query=None) %}
{#
    Renders the facet sidebar for search/browse results.
    - request_path: The base path for the links (e.g., /search or /browse/category-name)
    - request_args: The current query parameters.
#}
<div class="applied-filters">
    <h4>Applied Filters</h4>
    {# We now iterate through the processed facets to find selected items,
       which allows us to use the pre-formatted display strings. #}
    {% set has_selection = selected_facets.items()|length > 0 %}
    {% if has_selection %}
        <ul>
        {% for facet in facets %}
            {% for val in facet.values if val.selected %}
                <li class="applied-filter-tag">
                    {{ val.display }}
                    {# Logic to create a URL to remove this specific facet value. #}
                    {% set remove_args = request_args.to_dict(flat=False) %}
                    {% set _ = remove_args.get(facet.key, []).remove(val.value) %}
                    {# If the key has no more values, remove the key itself. #}
                    {% if not remove_args[facet.key] %}{% set _ = remove_args.pop(facet.key) %}{% endif %}
                    {% if attribution_token %}{% set _ = remove_args.update({'attribution_token': attribution_token}) %}{% endif %}
                    <a href="{{ request_path }}?{{ remove_args|urlencode }}" class="remove-facet-link" title="Remove filter">&times;</a>
                </li>
            {% endfor %}
        {% endfor %}
        </ul>
        {# Logic for the 'Clear All' link. #}
        {% set clear_args = {} %}
        {% if query %}{% set _ = clear_args.update({'query': query}) %}{% endif %}
        {% if request_args.get('expand') %}{% set _ = clear_args.update({'expand': request_args.get('expand')}) %}{% endif %}
        {% if attribution_token %}{% set _ = clear_args.update({'attribution_token': attribution_token}) %}{% endif %}
        <a href="{{ request_path }}?{{ clear_args|urlencode }}" class="clear-all-filters">Clear All</a>
    {% else %}
        <p>None</p>
    {% endif %}
</div>

<hr>

<div class="available-facets">
    <h4>Refine By</h4>
    {% for facet in facets if facet['values'] %}
        <div class="facet-group collapsible">
            {% set display_name = facet.display_name %}
            <button type="button" class="facet-toggle" data-bs-toggle="collapse" data-bs-target="#facet-values-{{ loop.index }}" aria-expanded="false" aria-controls="facet-values-{{ loop.index }}">
                <span>{{ display_name }}</span>
                <svg class="facet-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <div class="facet-values-container collapse" id="facet-values-{{ loop.index }}">
                <ul>
                {% for val in facet['values'] %}
                    <li class="facet-item {% if val.selected %}selected{% endif %}">
                        {% if val.selected %}
                            <span>{{ val.display }} ({{ val.count }})</span>
                        {% else %}
                            {% set add_args = request_args.to_dict(flat=False) %}
                            {% set existing_values = add_args.get(facet.key, []) %}
                            {% set _ = add_args.update({facet.key: existing_values + [val.value]}) %}
                            {% if attribution_token %}{% set _ = add_args.update({'attribution_token': attribution_token}) %}{% endif %}
                            <a href="{{ request_path }}?{{ add_args|urlencode }}">{{ val.display }} ({{ val.count }})</a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            </div>
        </div>
    {% else %}
        <p>No filters available for this search.</p>
    {% endfor %}
</div>
{% endmacro %}


{% macro render_pagination(current_page, total_pages, total_results, page_size, results_len, request_path, request_args, attribution_token) %}
{% if total_pages > 1 %}
<div class="pagination">
    <div class="pagination-summary">
        {% set start_item = (current_page - 1) * page_size + 1 %}
        {% set end_item = start_item + results_len - 1 %}
        Showing {{ start_item }}-{{ end_item }} of {{ "{:,}".format(total_results) }} results
    </div>
    <div class="pagination-links">
        {% if current_page > 1 %}{% set prev_args = request_args.to_dict(flat=False) %}{% set _ = prev_args.update({'page': current_page - 1, 'attribution_token': attribution_token}) %}<a href="{{ request_path }}?{{ prev_args|urlencode }}">&laquo; Previous</a>{% else %}<span class="disabled">&laquo; Previous</span>{% endif %}
        {% set page_window = 2 %}
        {% for p in range(1, total_pages + 1) %}
            {% if p == 1 or p == total_pages or (p >= current_page - page_window and p <= current_page + page_window) %}
                {% if loop.previtem and p > loop.previtem + 1 %}<span>...</span>{% endif %}
                {% if p == current_page %}<span class="active">{{ p }}</span>{% else %}{% set page_args = request_args.to_dict(flat=False) %}{% set _ = page_args.update({'page': p, 'attribution_token': attribution_token}) %}<a href="{{ request_path }}?{{ page_args|urlencode }}">{{ p }}</a>{% endif %}
            {% endif %}
        {% endfor %}
        {% if current_page < total_pages %}{% set next_args = request_args.to_dict(flat=False) %}{% set _ = next_args.update({'page': current_page + 1, 'attribution_token': attribution_token}) %}<a href="{{ request_path }}?{{ next_args|urlencode }}">Next &raquo;</a>{% else %}<span class="disabled">Next &raquo;</span>{% endif %}
    </div>
</div>
{% endif %}
{% endmacro %}