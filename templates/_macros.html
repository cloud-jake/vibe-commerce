{#
    This file contains reusable macros for rendering common components
    like product cards, facet sidebars, and pagination.
#}

{% macro render_product_card(item, attribution_token) %}
{#
    This macro is designed to be flexible. The 'item' can be either:
    1. A `Product` object (from recommendations on the homepage).
    2. A `SearchResult` object (from search and browse pages).
    The logic below handles both cases to extract the product details and the correct ID.
#}
{% set product = item.product if item.product is defined else item %}
<div class="product-card">
    <a href="{{ url_for('product_detail', product_id=item.id, attribution_token=attribution_token) }}">
        <img src="{{ (product.images[0].uri if product.images) or 'https://prd.place/400?id=' ~ item.id }}" alt="{{ product.title or 'Untitled Product' }}">
        <h3 class="product-title">{{ product.title or "Untitled Product" }}</h3>
        {% if product.price_info and product.price_info.price is defined and product.price_info.price is not none %}
            <p class="price">${{ "%.2f"|format(product.price_info.price) }}</p>
        {% else %}
            <p class="price price-unavailable">Price not available</p>
        {% endif %}
    </a>
</div>
{% endmacro %}


{% macro render_facets(facets, selected_facets, request_path, request_args, attribution_token, query=None) %}
{#
    Renders the facet sidebar for search/browse results.
    - request_path: The base path for the links (e.g., /search or /browse/category-name)
    - request_args: The current query parameters.
#}
<div class="applied-filters">
    <h4>Applied Filters</h4>
    {# We now iterate through the processed facets to find selected items,
       which allows us to use the pre-formatted display strings. #}
    {% set has_selection = selected_facets.items()|length > 0 %}
    {% if has_selection %}
        <ul>
        {% for facet in facets %}
            {% for val in facet['values'] if val.selected %}
                <li class="applied-filter-tag">
                    {{ val.display }}
                    {# To remove a filter, we rebuild the query string from all existing
                       request args, except for the specific key-value pair we're removing. #}
                    {% set remove_args_list = [] %}
                    {% for k, v in request.args.items(multi=True) %}
                        {% if not (k == facet.key and v == val.value) %}
                            {% do remove_args_list.append((k, v)) %}
                        {% endif %}
                    {% endfor %}
                    <a href="{{ request_path }}?{{ remove_args_list|urlencode }}" class="remove-facet-link" title="Remove filter">&times;</a>
                </li>
            {% endfor %}
        {% endfor %}
        </ul>
        {# Logic for the 'Clear All' link. #}
        {% set clear_args = {} %}
        {% if query %}{% set _ = clear_args.update({'query': query}) %}{% endif %}
        {% if request_args.get('expand') %}{% set _ = clear_args.update({'expand': request_args.get('expand')}) %}{% endif %}
        {% if attribution_token %}{% set _ = clear_args.update({'attribution_token': attribution_token}) %}{% endif %}
        <a href="{{ request_path }}?{{ clear_args|urlencode }}" class="clear-all-filters">Clear All</a>
    {% else %}
        <p>None</p>
    {% endif %}
</div>

<hr>

<div class="available-facets">
    <h4>Refine By</h4>
    {% for facet in facets if facet['values'] %}
        <div class="facet-group collapsible">
            {% set display_name = facet.display_name %}
            <button type="button" class="facet-toggle" data-bs-toggle="collapse" data-bs-target="#facet-values-{{ loop.index }}" aria-expanded="false" aria-controls="facet-values-{{ loop.index }}">
                <span>{{ display_name }}</span>
                <svg class="facet-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <div class="facet-values-container collapse" id="facet-values-{{ loop.index }}">
                <ul>
                {% for val in facet['values'] %}
                    <li class="facet-item {% if val.selected %}selected{% endif %}">
                        {% if val.selected %}
                            <span>{{ val.display }} ({{ val.count }})</span>
                        {% else %}
                            {# To add a filter, we rebuild the query string by taking all
                               current request args and appending the new facet selection. #}
                            {% set add_args_list = [] %}
                            {% for k, v in request.args.items(multi=True) %}
                                {% do add_args_list.append((k, v)) %}
                            {% endfor %}
                            {% do add_args_list.append((facet.key, val.value)) %}
                            <a href="{{ request_path }}?{{ add_args_list|urlencode }}">{{ val.display }} ({{ val.count }})</a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            </div>
        </div>
    {% else %}
        <p>No filters available for this search.</p>
    {% endfor %}
</div>
{% endmacro %}


{% macro render_pagination(current_page, total_pages, total_results, page_size, results_len, request_path, request_args, attribution_token) %}
{% if total_pages > 1 %}
<div class="pagination">
    <div class="pagination-summary">
        {% set start_item = (current_page - 1) * page_size + 1 %}
        {% set end_item = start_item + results_len - 1 %}
        Showing {{ start_item }}-{{ end_item }} of {{ "{:,}".format(total_results) }} results
    </div>
    <div class="pagination-links">
        {% if current_page > 1 %}
            {% set prev_args_list = [] %}
            {% for k, v in request.args.items(multi=True) if k != 'page' %}{% do prev_args_list.append((k, v)) %}{% endfor %}
            {% do prev_args_list.append(('page', current_page - 1)) %}
            <a href="{{ request_path }}?{{ prev_args_list|urlencode }}">&laquo; Previous</a>
        {% else %}<span class="disabled">&laquo; Previous</span>{% endif %}
        {% set page_window = 2 %}
        {% for p in range(1, total_pages + 1) %}
            {% if p == 1 or p == total_pages or (p >= current_page - page_window and p <= current_page + page_window) %}
                {% if loop.previtem and p > loop.previtem + 1 %}<span>...</span>{% endif %}
                {% if p == current_page %}<span class="active">{{ p }}</span>{% else %}
                    {% set page_args_list = [] %}
                    {% for k, v in request.args.items(multi=True) if k != 'page' %}{% do page_args_list.append((k, v)) %}{% endfor %}
                    {% do page_args_list.append(('page', p)) %}
                    <a href="{{ request_path }}?{{ page_args_list|urlencode }}">{{ p }}</a>{% endif %}
            {% endif %}
        {% endfor %}
        {% if current_page < total_pages %}
            {% set next_args_list = [] %}
            {% for k, v in request.args.items(multi=True) if k != 'page' %}{% do next_args_list.append((k, v)) %}{% endfor %}
            {% do next_args_list.append(('page', current_page + 1)) %}
            <a href="{{ request_path }}?{{ next_args_list|urlencode }}">Next &raquo;</a>{% else %}<span class="disabled">Next &raquo;</span>{% endif %}
    </div>
</div>
{% endif %}
{% endmacro %}